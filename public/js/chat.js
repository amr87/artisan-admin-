"use strict";$=jQuery.noConflict();var marqueeTitle,originalTitle="Dashboard";window.Artisan={},Artisan.getKey=function(e){if(!_.isObject(e))return void alert("Sorry, something went terribly wrong, please refresh the page and try again.");for(var t in e)if(e.propertyIsEnumerable(t))return t},Artisan.filter=function(e,t){return _.isObject(e)&&_.isString(t)?$(e.selector+t):void alert("Sorry, something went terribly wrong, please refresh the page and try again.")},Artisan.hasScrollBar=function(e){return _.isObject(e)?$(e).get(0).scrollHeight>$(e).get(0).clientHeight:void alert("Sorry, something went terribly wrong, please refresh the page and try again.")},Artisan.scrolledDown=function(e){return _.isObject(e)?$(e).get(0).scrollHeight-$(e).scrollTop()==$(e).outerHeight():void alert("Sorry, something went terribly wrong, please refresh the page and try again.")},Artisan.Notification=function(e){return _.isObject(e)?void noty({text:e.text,type:e.type,dismissQueue:!0,layout:"bottomLeft",closeWith:["click"],theme:"relax",maxVisible:10,animation:{open:"animated "+e.animation.open,close:"animated "+e.animation.close,easing:"swing",speed:500}}):void alert("Sorry, something went terribly wrong, please refresh the page and try again.")},Artisan.titleMarquee=function(e){if(!_.isString(e))return void alert("Sorry, something went terribly wrong, please refresh the page and try again.");originalTitle=document.title,document.title=e;var t=document.title+" - ";!function a(){document.title=t=t.substring(1)+t.substring(0,1),marqueeTitle=setTimeout(a,200)}()},Artisan.resetDocumentTitle=function(){window.clearTimeout(marqueeTitle),document.title=originalTitle,parseInt($("li.messages-menu").find("span").text())>0&&$("li.messages-menu").find("span").text(parseInt($("li.messages-menu").find("span").text())-1),$("li.messages-menu").find("span").removeClass("label-danger").addClass("label-success")},$=jQuery.noConflict(),window.ArtisanChat={},ArtisanChat.holder=$(".chat-area"),ArtisanChat.count=0,ArtisanChat.position=0,ArtisanChat.chattingWith="",ArtisanChat.init=function(e){return _.isObject(e)?(this.count=Artisan.filter(this.holder,":visible").length,this.position=this.count*parseInt(this.holder.css("width")),$._widget=this.build(e),void $._widget.fadeIn("slow",function(){ArtisanChat.count++,$._widget.attr("data-client",$(e).data("client")),$._widget.attr("data-id",$(e).data("id"));var t="SPAN"==$(e).get(0).nodeName?$(e).prev().text():$(e).data("with");$._widget.find(".chat-with").text(t);var a=ArtisanChat.loadConversation(e,null);a.length&&$._widget.find(".direct-chat-messages").prepend($("<a class='prev-msg' href='#'><i class='fa fa-arrow-up'></i> Load More Messages<br/><span class='fa fa-spinner fa-spin'></span></a>")),$._widget.find(".spin-it").remove(),$._widget.find(".direct-chat-messages").append(a),$._widget.find("input#message").typing({start:function(e,t){var a=t.parent().parent().parent().parent().data("client");socket.emit("typing",{user_id:$("input#myId").val(),target_id:$._widget.data("id"),client:a,senderClient:Artisan.filter($("span.chat-start"),"[data-id='"+$("input#myId").val()+"']").data("client")})},stop:function(e,t){var a=t.parent().parent().parent().parent().data("client");socket.emit("untyping",{user_id:$("input#myId").val(),target_id:$._widget.data("id"),client:a,senderClient:Artisan.filter($("span.chat-start"),"[data-id='"+$("input#myId").val()+"']").data("client")})},delay:400})})):void alert("Sorry, something went terribly wrong, please refresh the page and try again.")},ArtisanChat.build=function(e){if(!_.isObject(e))return void alert("Sorry, something went terribly wrong, please refresh the page and try again.");var t=_.isUndefined(e.selector)?e.senderId:e.data("id"),a=Artisan.filter(this.holder,"[data-id='"+t+"']");return a.length?($._widget=a,this.RePosition("re-appear",$._widget)):($._widget=this.holder.clone(),$._widget.css({right:this.position})),$._widget.appendTo($("body")),$._widget},ArtisanChat.loadConversation=function(e,t){var a="",s=_.isObject(e)?e.data("id"):e,n=null===t?0:t;return $.ajax({url:"/get-conversation",type:"GET",data:{to:s,skip:n},async:!1,success:function(e){if(e.length)for(var t=0;t<e.length;t++)e[t].mine?(a+="<div data-mine='1' data-id='"+e[t].id+"' data-seen='"+e[t].seen+"' class='direct-chat-msg'>\n",a+="<div class='direct-chat-info clearfix'>\n",a+=" <span class='direct-chat-name pull-left'>"+e[t].sender.display_name+"</span>\n",a+="<span class='direct-chat-timestamp pull-right'>"+e[t].sent_at+"</span>\n",a+="</div>\n",a+="<img class='direct-chat-img' src='"+e[t].sender.avatar+"' alt='Message User Image'>\n",a+="<div class='direct-chat-text'>\n",a+=e[t].text+"\n","1"==e[t].seen&&t==e.length-1&&0==n&&(a+="<p class='seen-mark'><i class='fa fa-eye'></i> At "+e[t].seen_at+"</p>"),a+=" </div>\n",a+="</div>"):(a+="<div data-mine='0' data-id='"+e[t].id+"' data-seen='"+e[t].seen+"' class='direct-chat-msg right'>\n",a+="<div class='direct-chat-info clearfix'>\n",a+=" <span class='direct-chat-name pull-right'>"+e[t].sender.display_name+"</span>\n",a+="<span class='direct-chat-timestamp pull-left'>"+e[t].sent_at+"</span>\n",a+="</div>\n",a+="<img class='direct-chat-img' src='"+e[t].sender.avatar+"' alt='Message User Image'>\n",a+="<div class='direct-chat-text'>\n",a+=e[t].text+"\n",a+=" </div>\n",a+="</div>")}}),a},ArtisanChat.sendMessage=function(e){if(!_.isObject(e))return void alert("Sorry, something went terribly wrong, please refresh the page and try again.");var t=$(e).parent().prev().val();if(""==t)return void alert("You must type a message");var a=$(e).parent().parent().parent().parent().parent(),s=a.data("id"),n=Artisan.filter($("span.chat-start"),"[data-id='"+s+"']").data("client"),i=a.data("name"),r=a.data("avatar"),d=$("input#myId").val(),l=Artisan.filter($("span.chat-start"),"[data-id='"+d+"']").data("client"),o="";o+="<div data-seen='1' data-mine='1' class='direct-chat-msg'>\n",o+="<div class='direct-chat-info clearfix'>\n",o+=" <span class='direct-chat-name pull-left'>"+i+"</span>\n",o+="<span class='direct-chat-timestamp pull-left' data-timestamp='"+(new Date).getTime()+"'>Now</span>\n",o+="</div>\n",o+="<img class='direct-chat-img' src='"+r+"' alt='Message User Image'>\n",o+="<div class='direct-chat-text'>\n",o+=t+"\n",o+=" </div>\n",o+="</div>",a.find(".direct-chat-messages").append(o),a.find(".direct-chat-messages").animate({scrollTop:a.find(".direct-chat-messages").get(0).scrollHeight+"px"}),a.find(".seen-mark").remove(),$.post("/post-message",{to:s,message:t},function(e){var a=JSON.parse(e);0!=a.id&&socket.emit("message",{message:t,client:n,user_id:s,name:i,avatar:r,senderId:d,sclient:l,msg_id:a.id})}),$(e).parent().prev().val("")},ArtisanChat.receiveMessage=function(e){if(!_.isObject(e))return void d("Sorry, something went terribly wrong, please refresh the page and try again.");var t=$("li.messages-menu").find("span");t.removeClass("label-success").addClass("label-danger").text(parseInt(t.text())+1);var a=_.isUndefined(e.selector)?e.senderId:e.data("id"),s=Artisan.filter(this.holder,"[data-id='"+a+"']");if(s.length){var n="";$._widget=s,$._widget.find(".box-header").addClass("redish"),n+="<div data-seen='0'  data-mine='0' data-id='"+e.msg_id+"' class='direct-chat-msg right'>\n",n+="<div class='direct-chat-info clearfix'>\n",n+=" <span class='direct-chat-name pull-right'>"+e.name+"</span>\n",n+="<span class='direct-chat-timestamp pull-left' data-timestamp='"+(new Date).getTime()+"'>Now</span>\n",n+="</div>\n",n+="<img class='direct-chat-img' src='"+e.avatar+"' alt='Message User Image'>\n",n+="<div class='direct-chat-text' style='height:30px !important'>\n",n+=e.message+"\n",n+=" </div>\n",n+="</div>",$._widget.find(".direct-chat-messages").find("a.prev-msg").length||$._widget.find(".direct-chat-messages").prepend($("<a class='prev-msg' href='#'><i class='fa fa-arrow-up'></i> Load More Messages<br/><span class='fa fa-spinner fa-spin'></span></a>"));var i=Artisan.hasScrollBar($._widget.find(".direct-chat-messages")),r=Artisan.scrolledDown($._widget.find(".direct-chat-messages"));if(i&&!r&&!$._widget.find("span.new-messages").length){var d=$("span.new-messages").clone();d.prependTo($._widget.find(".box-body")).fadeIn()}$._widget.find(".direct-chat-messages").append(n),$._widget.find(".seen-mark").remove()}else{var l=$("#noty_bottomLeft_layout_container>li:first-child>.noty_bar").attr("id"),o=$("#noty_bottomLeft_layout_container li").size();o>=1&&$.noty.close(l),Artisan.Notification({text:"<img class= 'direct-chat-img' src='"+e.avatar+"'/>\n                <p><i class='fa fa-envelope'></i> <strong>"+e.name+" </strong> sent you a message.</p><div style='clear:both'</div>\n                ",type:"success",animation:{open:"zoomIn",close:"zoomOut"}})}var c=$("li.chat-start[data-id='"+a+"']");c.length&&(c.hasClass("pale-red")||c.addClass("pale-red"),c.find("p").text(e.message),c.find("h4 small").html("<i class='fa fa-clock-o'></i>Now")),Artisan.titleMarquee(e.name+" Messaged you")},ArtisanChat.close=function(e){return _.isObject(e)?($(e).parent().parent().parent().parent().remove(),void this.RePosition("delete",{})):void alert("Sorry, something went terribly wrong, please refresh the page and try again.")},ArtisanChat.RePosition=function(e,t){if(!_.isString(e)||!_.isObject(t))return void alert("Sorry, something went terribly wrong, please refresh the page and try again.");if("delete"==e)Artisan.filter(this.holder,":visible").each(function(e,t){$(t).animate({right:e*parseInt($(t).css("width"))+"px"},"slow")});else if("re-appear"==e){var a=parseInt(t.css("right")),s=Artisan.filter(this.holder,":visible");s.each(function(e,s){if(parseInt($(s).css("right"))==a&&"block"!=t.css("style")){var n=this.count*parseInt(ArtisanChat.css("width"));$(s).animate({right:n+"px"},"slow")}})}};var current;ArtisanChat.setSeen=function(e){if(!_.isObject(e))return void alert("Sorry, something went terribly wrong, please refresh the page and try again.");if(current=$(e),$(current).find(".box-header").removeClass("redish"),Artisan.resetDocumentTitle(),Artisan.scrolledDown($(current).find(".direct-chat-messages"))){var t=$(current).find(".direct-chat-msg[data-seen='0']");if(t.length){for(var a=[],s=0;s<t.length;s++)a.push($(t[s]).data("id"));if(a.length){if(current.data("requestRunning"))return;current.data("requestRunning",!0),$.ajax({type:"POST",url:"/message-seen",data:{id:a},success:function(e){var t=JSON.parse(e);if(t.length){for(var a=0;a<t.length;a++)$(".direct-chat-msg[data-id = '"+t[a].id+"']").attr("data-seen","1");var s=Artisan.filter($("span.chat-start"),"[data-id='"+$("input#myId").val()+"']").data("client");socket.emit("seen",{user_id:$("input#myId").val(),target_id:$._widget.data("id"),client:$(current).data("client"),senderClient:s,msg_id:t[a-1].id,msg_seen:t[a-1].seen_at})}},complete:function(){current.data("requestRunning",!1)}})}}}},ArtisanChat.loadPreviousMessages=function(e){if(!_.isObject(e))return void alert("Sorry, something went terribly wrong, please refresh the page and try again.");$(e).find("span").fadeIn();var t=$(e).parent().parent().parent().parent(),a=t.data("id"),s=$(e).parent().find(".direct-chat-msg").length,n=ArtisanChat.loadConversation(a,s);$(e).find("span").fadeOut(),$(n).insertAfter($(e)),n.length||$(e).remove()},ArtisanChat.loadUserConversations=function(){$.get("/user-conversations",{},function(e){var t=JSON.parse(e),a="";if(t.length>0){a+="<li class='header'>You have "+t.length+" conversation(s)</li>",a+="<li><ul class='menu conversation-holder'>";for(var s=0;s<t.length;s++){if(t[s].messages[0].mine){var n=$("span.chat-start[data-id='"+t[s].messages[0].receiver.id+"']"),i=n.length?n.data("client"):null,r="1"==t[s].messages[0].seen?"<i class='fa fa-eye'></i>":"";a+=" <li data-with='"+t[s].messages[0].receiver.display_name+"' class='chat-start' data-id='"+t[s].messages[0].receiver.id+"' data-client='"+i+"'> <a href='#'><div class='pull-left'>",a+=" <img src='"+t[s].messages[0].receiver.avatar+"' class='img-circle' alt='User Image'></div> <h4>\n                                                             "+t[s].messages[0].receiver.display_name+" \n                                                                <small><i class='fa fa-clock-o'></i> \n                                                             "+t[s].messages[0].sent_at+"</small></h4>\n                                                              <p>You: "+t[s].messages[0].text+" "+r+"</p>"}else{var n=$("span.chat-start[data-id='"+t[s].messages[0].sender.id+"']"),d="1"==t[s].messages[0].seen?"":"pale-red",i=n.length?n.data("client"):null;a+=" <li data-with='"+t[s].messages[0].sender.display_name+"' class='chat-start "+d+"' data-id='"+t[s].messages[0].sender.id+"' data-client='"+i+"'> <a href='#'><div class='pull-left'>",a+=" <img src='"+t[s].messages[0].sender.avatar+"' class='img-circle' alt='User Image'></div>\n                                  <h4>"+t[s].messages[0].sender.display_name+"   <small><i class='fa fa-clock-o'></i> \n                                                             "+t[s].messages[0].sent_at+"</small></h4>\n                                                                <p>"+t[s].messages[0].text+"</p>"}a+="</a></li>"}a+="</ul>"}else a+="<h4>No Conversations yet</h4>",a+="</ul>";$("li.messages-menu").find("ul.dropdown-menu").html(a)})},socket.on("user-login",function(e){$.get("/admin/users/saveClient",e,function(){})}),socket.on("user-update",function(e){var e=JSON.parse(e);$("body").css("overflow","hidden"),$(".overlay-update").fadeIn("slow"),$.post("/admin/users/flushSession",e,function(){}),window.setTimeout(function(){window.location.reload()},5e3)}),socket.on("user-ban",function(e){var e=JSON.parse(e);$("body").css("overflow","hidden"),$(".overlay-ban").fadeIn("slow"),window.setTimeout(function(){window.location.href="/logout"},5e3)}),socket.on("seen",function(e){var t=$("<p/>");t.addClass("seen-mark");var a=$(".chat-area[data-id='"+e.user_id+"']");a.length&&(t.html("<i class='fa fa-eye'></i> At "+e.msg_seen),t.appendTo(a.find(".direct-chat-text:last")))}),socket.on("typing",function(e){var t=$("<p/>");t.addClass("typing");var a=$(".chat-area[data-id='"+e.user_id+"']");a.length&&(a.find("p.typing").length&&a.find("p.typing").remove(),t.html("<i class='fa fa-pencil'></i> typing...."),t.insertAfter(a.find(".direct-chat-text:last")))}),socket.on("untyping",function(e){var t=$(".chat-area[data-id='"+e.user_id+"']");t.find("p.typing").length&&t.find(".typing").remove()}),socket.on("connectedUser",function(e){$("div.users-online").find(".control-sidebar-heading").html(" Online Users <strong style='color:yellow'>( "+e.users.length+" )</strong>");var t="";t+="<ul id='online-users'>";for(var a=0;a<e.users.length;a++){var s=Artisan.getKey(e.users[a]);t+="<li><img class='img-circle' src='"+e.users[a].avatar+"' width='50'/>\n                        <a href='/admin/users/"+s+"'>"+e.users[a].name+"</a>\n                        <span title='Chat with "+e.users[a].name+"' data-id='"+s+"'  data-client='"+e.users[a][s]+"' class='fa fa-lg fa-comment chat-start'></span>\n                        \n<div style='clear:both'></div>\n                   </li>",$("ul.conversation-holder li[data-id='"+s+"']").length&&$("ul.conversation-holder li[data-id='"+s+"']").attr("data-client",e.users[a][s])}t+="</ul>",$(".users-online").find(".overlay").remove(),$(".users-online").find(".box-body").html(t)}),$(function(){$("body").delegate(".chat-start","click",function(){ArtisanChat.init($(this))}),$("body").delegate("button.send-message","click",function(){ArtisanChat.sendMessage($(this))}),$("body").delegate("button.btn-close-chat","click",function(){ArtisanChat.close($(this))}),socket.on("message",function(e){ArtisanChat.receiveMessage(e)}),$("body").delegate("button[data-widget='collapse']","click",function(){$(this).parent().parent().hasClass("redish")&&$(this).parent().parent().removeClass("redish")}),$("body").delegate("span.new-messages","click",function(){$(this).parent().find(".direct-chat-messages").animate({scrollTop:$(this).parent().find(".direct-chat-messages").get(0).scrollHeight+"px"},"slow"),$(this).parent().prev().removeClass("redish"),$(this).remove()}),$("body").delegate(".chat-area","mouseover",function(){ArtisanChat.setSeen($(this))}),$("body").delegate("a.prev-msg","click",function(){ArtisanChat.loadPreviousMessages($(this))}),$("li.messages-menu ").on("click",function(){ArtisanChat.loadUserConversations()}),$("li.messages-menu").on("click",function(){$(this).find("span").removeClass("label-danger").addClass("label-success").text(0),Artisan.resetDocumentTitle()})});